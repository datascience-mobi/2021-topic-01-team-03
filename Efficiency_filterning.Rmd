---
title: "Efficiency filtering for subtypes"
author: "Xenia Quaas"
date: "28 5 2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
load("../2021-topic-01-team-03/dataset/prism_datasets.rda")
load("../2021-topic-01-team-03/dataset/cellline_datasets.rda")
```


# Alternative: Selecting drugs that are specifically effective for the subtypes

##First way: Dividing dataset before filtering for efficiency
```{r}
#identify the brain cancer cell lines' names
brain_cancer_cl=subset.data.frame(prism.cl, disease == 	"Brain Cancer") 
names=brain_cancer_cl[,1]
brain_cancer=prism[names,]

# NA substitution of brain_cancer
for(i in 1:ncol(brain_cancer)){
  brain_cancer[is.na(brain_cancer[,i]), i] <- mean(brain_cancer[,i], na.rm = TRUE)
}
brain_cancer=brain_cancer[ , colSums(is.na(brain_cancer)) == 0]


```

```{r}
#dividing data sets into subtypes

glioblastoma=brain_cancer_cl$DepMap_ID[grep("Glioblastoma", brain_cancer_cl$disease_subtype)]

medulloblastoma=brain_cancer_cl$DepMap_ID[grep("Medulloblastoma", brain_cancer_cl$disease_subtype)]

glioma=brain_cancer_cl$DepMap_ID[grep("Glioma", brain_cancer_cl$disease_subtype)]

astrocytoma=brain_cancer_cl$DepMap_ID[grep("Astrocytoma", brain_cancer_cl$disease_subtype)]

disease_subtypes=c(medulloblastoma,glioblastoma,glioma,astrocytoma)
```

```{r}
#dividing brain_cancer dataset into subtypes
# I think this was not neccesary

glioblastoma_bc <- brain_cancer[glioblastoma,]
View(glioblastoma_bc)

# Check that everything went correctly
nrow(glioblastoma_bc)
length(glioblastoma)

# other subtypes
medulloblastoma_bc <- brain_cancer[medulloblastoma,]
glioma_bc <- brain_cancer[glioma,]
astrocytoma_bc <- brain_cancer[astrocytoma,]


```


```{r}
# dividing normal brain cancer dataset in dosages 

dd1=grep("::0.00061034::", colnames(brain_cancer))
dd2=grep("::0.0024414::", colnames(brain_cancer))
dd3=grep("::0.00976562::", colnames(brain_cancer))
dd4=grep("::0.0390625::", colnames(brain_cancer))
dd5=grep("::0.15625::", colnames(brain_cancer))
dd6=grep("::0.625::", colnames(brain_cancer))
dd7=grep("::10::", colnames(brain_cancer))
dd8=grep("::2.5::", colnames(brain_cancer))
#positions of the respective doses in the dataframe 
doses=c(dd1,dd2,dd3,dd4,dd5,dd6,dd7,dd8)

d1=brain_cancer[,dd1]
d2=brain_cancer[,dd2]
d3=brain_cancer[,dd3]
d4=brain_cancer[,dd4]
d5=brain_cancer[,dd5]
d6=brain_cancer[,dd6]
d7=brain_cancer[,dd7]
d8=brain_cancer[,dd8]

deviation=brain_cancer[,-doses] 
questionable_drugs=prism.treat[colnames(deviation),]

#Calculation of all differences between questionable drugs and standard doses
std_doses <- c(0.00061034,0.0024414,0.00976562,0.0390625,0.15625,0.625,10,2.5) #vector with standard dosages

#Picking dosages from dosages that have to be assigned to standard dosages
doses_to_assign=as.numeric(questionable_drugs$dose)

#Creating data frame for the differences between standard dosages and questionable drugs
extra_drugs <-data.frame(matrix(nrow = 8,ncol = length(doses_to_assign)),row.names = std_doses)
colnames(extra_drugs)=rownames(questionable_drugs)

for (i in 1:length(doses_to_assign)){
    extra_drugs[,i]=abs(std_doses - doses_to_assign[i])
}

#Assigning the drugs to the closest standard dosage 
to_which_dose=apply(extra_drugs, 2, which.min) #function of which.min: gives row number of min value of column. In comparison just apply: gives min difference

d1_extra=which(to_which_dose==1)
d2_extra=which(to_which_dose==2)
d3_extra=which(to_which_dose==3)
d4_extra=which(to_which_dose==4)
d5_extra=which(to_which_dose==5)
d6_extra=which(to_which_dose==6)
d7_extra=which(to_which_dose==7)
d8_extra=which(to_which_dose==8)

#just a quick check how many doses there are in total
not_standard_doses=c(d1_extra,d2_extra,d3_extra,d4_extra,d5_extra,d6_extra,d7_extra,d8_extra)
length(not_standard_doses)#in comparison with dimension from questionable_drugs right!

#Adding new assigned dosages to small data frames of standard dosages 
add_extra_doses=function(x,y){cbind(brain_cancer[,unique(grep(paste(colnames(extra_drugs[,x]),collapse="|"), colnames(brain_cancer)))], y)}

d1=add_extra_doses(d1_extra,d1)
View(d1)
d2=add_extra_doses(d2_extra,d2)
d3=add_extra_doses(d3_extra,d3)
d4=add_extra_doses(d4_extra,d4)
d5=add_extra_doses(d5_extra,d5)
d6=add_extra_doses(d6_extra,d6)
d7=add_extra_doses(d7_extra,d7)
d8=add_extra_doses(d8_extra,d8)
```


```{r}
# dividing subtypes into dosages

gb1=d1[glioblastoma,]
gb2=d2[glioblastoma,]
gb3=d3[glioblastoma,]
gb4=d4[glioblastoma,]
gb5=d5[glioblastoma,]
gb6=d6[glioblastoma,]
gb7=d7[glioblastoma,]
gb8=d8[glioblastoma,]

mb1=d1[medulloblastoma,]
mb2=d2[medulloblastoma,]
mb3=d3[medulloblastoma,]
mb4=d4[medulloblastoma,]
mb5=d5[medulloblastoma,]
mb6=d6[medulloblastoma,]
mb7=d7[medulloblastoma,]
mb8=d8[medulloblastoma,]

g1=d1[glioma,]
g2=d2[glioma,]
g3=d3[glioma,]
g4=d4[glioma,]
g5=d5[glioma,]
g6=d6[glioma,]
g7=d7[glioma,]
g8=d8[glioma,]

ac1=d1[astrocytoma,]
ac2=d2[astrocytoma,]
ac3=d3[astrocytoma,]
ac4=d4[astrocytoma,]
ac5=d5[astrocytoma,]
ac6=d6[astrocytoma,]
ac7=d7[astrocytoma,]
ac8=d8[astrocytoma,]
```

# Filter effective drugs in each dose group

```{r}
#Lets say for now that our threshold is 0,3 so we can see how many drugs meet this criteria in each dose group

effective_drugs<-function(x){
  effective_x<-x[,which(apply(x,2,mean)<=0.2)]
  return(effective_x)
}

effective_d1=effective_drugs(d1)
effective_d2=effective_drugs(d2)
effective_d3=effective_drugs(d3)
effective_d4=effective_drugs(d4)
effective_d5=effective_drugs(d5)
effective_d6=effective_drugs(d6)
effective_d7=effective_drugs(d7)
effective_d8=effective_drugs(d8)

effective_gb1=effective_drugs(gb1)
effective_gb2=effective_drugs(gb2)
effective_gb3=effective_drugs(gb3)
effective_gb4=effective_drugs(gb4)
effective_gb5=effective_drugs(gb5)
effective_gb6=effective_drugs(gb6)
effective_gb7=effective_drugs(gb7)
effective_gb8=effective_drugs(gb8)


# comparison
# number of treatments in glioblastoma is for every dosage lower
# same number within dosage 7
# length of all effective treatments without division into subtypes: 6846
# length of all effective treatments within glioblastoma: 6671
# Resumé: although there are less cell lines that have to fulfill the criteria, there are less treatments that are effective. An explanation is that cell lines were removed that had high drug responses in these treatments

effective_mb1=effective_drugs(mb1)
effective_mb2=effective_drugs(mb2)
effective_mb3=effective_drugs(mb3)
effective_mb4=effective_drugs(mb4)
effective_mb5=effective_drugs(mb5)
effective_mb6=effective_drugs(mb6)
effective_mb7=effective_drugs(mb7)
effective_mb8=effective_drugs(mb8)


# Comparison
# number of treatments is constantly higher
# doses 7 is nearly the same number (by 5 higher in medullablastoma)
# reminder: only two cell lines belong to medulloblastoma
# they both have to respond similar 
# length of all effective treatments within medulloblastoma: 7824
# Resumé: There are more than 1000 additional treatments for medulloblastoma compared to treating all cell lines

effective_g1=effective_drugs(g1)
effective_g2=effective_drugs(g2)
effective_g3=effective_drugs(g3)
effective_g4=effective_drugs(g4)
effective_g5=effective_drugs(g5)
effective_g6=effective_drugs(g6)
effective_g7=effective_drugs(g7)
effective_g8=effective_drugs(g8)


# Comparison
# number of glioma treatments are less in every dosage 
# number of treatments within dosage 7 is by 47 treatments lower in glioma than the number in all cell lines
# length of all effective treatments within glioma: 6273
# Resumé: glioma has 500 less treatments than all cell lines
# it could be concluded that cell lines within the subtype respond really different to a treatment 

effective_ac1=effective_drugs(ac1)
effective_ac2=effective_drugs(ac2)
effective_ac3=effective_drugs(ac3)
effective_ac4=effective_drugs(ac4)
effective_ac5=effective_drugs(ac5)
effective_ac6=effective_drugs(ac6)
effective_ac7=effective_drugs(ac7)
effective_ac8=effective_drugs(ac8)

sum(ncol(effective_ac1), ncol(effective_ac2), ncol(effective_ac3), ncol(effective_ac4), ncol(effective_ac5), ncol(effective_ac6), ncol(effective_ac7), ncol(effective_ac8))

# Comparison
# number of treatments effective in astrocytoma are constantly higher than in all cell lines
# doses 7 is nearly the same number (astrocytoma has one more treatment)
# length of all effective treatments within astrocytoma: 7523
# around 700 higher than when measured in all cell lines


# d7 is highest dosage; the less difference between number of treatments for subtypes and number of treatments for all cell lines 
# exception: number of treatments for glioma differs 

```

# To Do: Visualization of drugs in d7 that are not effective in treating glioma 

# Select drugs that are effective in all doses

#First for glioblastoma

```{r}

## remove everything but the drug information from colnames and make them new colnames of the dataframes

new_colnames <- function(x){
  a<-gsub(pattern = "::.*", replacement = "", colnames(x))
  return(a)
}
colnames(effective_gb1)<-new_colnames(effective_gb1)
colnames(effective_gb2)<-new_colnames(effective_gb2)
colnames(effective_gb3)<-new_colnames(effective_gb3)
colnames(effective_gb4)<-new_colnames(effective_gb4)
colnames(effective_gb5)<-new_colnames(effective_gb5)
colnames(effective_gb6)<-new_colnames(effective_gb6)
colnames(effective_gb7)<-new_colnames(effective_gb7)
colnames(effective_gb8)<-new_colnames(effective_gb8)


common_drugs<-function(x,y){
  different<-setdiff(colnames(x), colnames(y))
  
  different<-unique(grep(paste(different,collapse="|"), colnames(x)))
  
  colnames(x[,-different])
}
#function returns the names of the common drugs between 2 dataframes

gb1_gb2=common_drugs(effective_gb1,effective_gb2)
gb1_gb3=common_drugs(effective_gb1,effective_gb3)
gb1_gb4=common_drugs(effective_gb1,effective_gb4)
gb1_gb5=common_drugs(effective_gb1,effective_gb5)
gb1_gb6=common_drugs(effective_gb1,effective_gb6)
gb1_gb7=common_drugs(effective_gb1,effective_gb7)
gb1_gb8=common_drugs(effective_gb1,effective_gb8)

#which drugs are present in all 8 doses?

present_in_all_doses<-function(a,b,c,d,e,f,g){
 bb<-setdiff(a, b)
 a<-a [! a %in% bb]
 
 cc<-setdiff(a, c)
 a<-a [! a %in% cc]
 
 dd<-setdiff(a, d)
 a<-a [! a %in% dd]
 
 ee<-setdiff(a, e)
 a<-a [! a %in% ee]
 
 ff<-setdiff(a, f)
 a<-a [! a %in% ff]
 
 gg<-setdiff(a, g)
 a<-a [! a %in% gg]
 
 return(a)
}

effective_in_all_doses_gb=present_in_all_doses(gb1_gb2,gb1_gb3,gb1_gb4,gb1_gb5,gb1_gb6,gb1_gb7,gb1_gb8)
length(effective_in_all_doses_gb)
#119 drugs are effective in all doses in glioblastoma subtype
#in comparison in all cell lines: 160 
```

# Now for all the other subtypes
```{r}
# medulloblastoma 

new_colnames <- function(x){
  a<-gsub(pattern = "::.*", replacement = "", colnames(x))
  return(a)
}
colnames(effective_mb1)<-new_colnames(effective_mb1)
colnames(effective_mb2)<-new_colnames(effective_mb2)
colnames(effective_mb3)<-new_colnames(effective_mb3)
colnames(effective_mb4)<-new_colnames(effective_mb4)
colnames(effective_mb5)<-new_colnames(effective_mb5)
colnames(effective_mb6)<-new_colnames(effective_mb6)
colnames(effective_mb7)<-new_colnames(effective_mb7)
colnames(effective_mb8)<-new_colnames(effective_mb8)


common_drugs<-function(x,y){
  different<-setdiff(colnames(x), colnames(y))
  
  different<-unique(grep(paste(different,collapse="|"), colnames(x)))
  
  colnames(x[,-different])
}
#function returns the names of the common drugs between 2 dataframes

mb1_mb2=common_drugs(effective_mb1,effective_mb2)
mb1_mb3=common_drugs(effective_mb1,effective_mb3)
mb1_mb4=common_drugs(effective_mb1,effective_mb4)
mb1_mb5=common_drugs(effective_mb1,effective_mb5)
mb1_mb6=common_drugs(effective_mb1,effective_mb6)
mb1_mb7=common_drugs(effective_mb1,effective_mb7)
mb1_mb8=common_drugs(effective_mb1,effective_mb8)

#which drugs are present in all 8 doses?

present_in_all_doses<-function(a,b,c,d,e,f,g){
 bb<-setdiff(a, b)
 a<-a [! a %in% bb]
 
 cc<-setdiff(a, c)
 a<-a [! a %in% cc]
 
 dd<-setdiff(a, d)
 a<-a [! a %in% dd]
 
 ee<-setdiff(a, e)
 a<-a [! a %in% ee]
 
 ff<-setdiff(a, f)
 a<-a [! a %in% ff]
 
 gg<-setdiff(a, g)
 a<-a [! a %in% gg]
 
 return(a)
}

effective_in_all_doses_mb=present_in_all_doses(mb1_mb2,mb1_mb3,mb1_mb4,mb1_mb5,mb1_mb6,mb1_mb7,mb1_mb8)
length(effective_in_all_doses_mb)
#220 drugs are effective in all doses for medulloblastoma subtype
```

```{r}
# glioma
new_colnames <- function(x){
  a<-gsub(pattern = "::.*", replacement = "", colnames(x))
  return(a)
}
colnames(effective_g1)<-new_colnames(effective_g1)
colnames(effective_g2)<-new_colnames(effective_g2)
colnames(effective_g3)<-new_colnames(effective_g3)
colnames(effective_g4)<-new_colnames(effective_g4)
colnames(effective_g5)<-new_colnames(effective_g5)
colnames(effective_g6)<-new_colnames(effective_g6)
colnames(effective_g7)<-new_colnames(effective_g7)
colnames(effective_g8)<-new_colnames(effective_g8)


common_drugs<-function(x,y){
  different<-setdiff(colnames(x), colnames(y))
  
  different<-unique(grep(paste(different,collapse="|"), colnames(x)))
  
  colnames(x[,-different])
}
#function returns the names of the common drugs between 2 dataframes
g1_g2=common_drugs(effective_g1,effective_g2)
g1_g3=common_drugs(effective_g1,effective_g3)
g1_g4=common_drugs(effective_g1,effective_g4)
g1_g5=common_drugs(effective_g1,effective_g5)
g1_g6=common_drugs(effective_g1,effective_g6)
g1_g7=common_drugs(effective_g1,effective_g7)
g1_g8=common_drugs(effective_g1,effective_g8)

#which drugs are present in all 8 doses?

present_in_all_doses<-function(a,b,c,d,e,f,g){
 bb<-setdiff(a, b)
 a<-a [! a %in% bb]
 
 cc<-setdiff(a, c)
 a<-a [! a %in% cc]
 
 dd<-setdiff(a, d)
 a<-a [! a %in% dd]
 
 ee<-setdiff(a, e)
 a<-a [! a %in% ee]
 
 ff<-setdiff(a, f)
 a<-a [! a %in% ff]
 
 gg<-setdiff(a, g)
 a<-a [! a %in% gg]
 
 return(a)
}

effective_in_all_doses_g=present_in_all_doses(g1_g2,g1_g3,g1_g4,g1_g5,g1_g6,g1_g7,g1_g8)
length(effective_in_all_doses_g)
# 76 drugs are effective in all doses for glioma subtype
```

```{r}
# astrocytoma

new_colnames <- function(x){
  a<-gsub(pattern = "::.*", replacement = "", colnames(x))
  return(a)
}
colnames(effective_ac1)<-new_colnames(effective_ac1)
colnames(effective_ac2)<-new_colnames(effective_ac2)
colnames(effective_ac3)<-new_colnames(effective_ac3)
colnames(effective_ac4)<-new_colnames(effective_ac4)
colnames(effective_ac5)<-new_colnames(effective_ac5)
colnames(effective_ac6)<-new_colnames(effective_ac6)
colnames(effective_ac7)<-new_colnames(effective_ac7)
colnames(effective_ac8)<-new_colnames(effective_ac8)


common_drugs<-function(x,y){
  different<-setdiff(colnames(x), colnames(y))
  
  different<-unique(grep(paste(different,collapse="|"), colnames(x)))
  
  colnames(x[,-different])
}
#function returns the names of the common drugs between 2 dataframes
ac1_ac2=common_drugs(effective_ac1,effective_ac2)
ac1_ac3=common_drugs(effective_ac1,effective_ac3)
ac1_ac4=common_drugs(effective_ac1,effective_ac4)
ac1_ac5=common_drugs(effective_ac1,effective_ac5)
ac1_ac6=common_drugs(effective_ac1,effective_ac6)
ac1_ac7=common_drugs(effective_ac1,effective_ac7)
ac1_ac8=common_drugs(effective_ac1,effective_ac8)

#which drugs are present in all 8 doses?

present_in_all_doses<-function(a,b,c,d,e,f,g){
 bb<-setdiff(a, b)
 a<-a [! a %in% bb]
 
 cc<-setdiff(a, c)
 a<-a [! a %in% cc]
 
 dd<-setdiff(a, d)
 a<-a [! a %in% dd]
 
 ee<-setdiff(a, e)
 a<-a [! a %in% ee]
 
 ff<-setdiff(a, f)
 a<-a [! a %in% ff]
 
 gg<-setdiff(a, g)
 a<-a [! a %in% gg]
 
 return(a)
}

effective_in_all_doses_ac=present_in_all_doses(ac1_ac2,ac1_ac3,ac1_ac4,ac1_ac5,ac1_ac6,ac1_ac7,ac1_ac8)
length(effective_in_all_doses_ac)

# 89 drugs are effective in all doses in astrocytoma subtype
```

## Clustering of the effective drugs 


```{r}
if ( (i %in% row.names(brain_cancer) &  (i %in% effective_in_all_doses_ac[ , 2]) ) 
     {values <- i}
    else 
      {rm(i)}

  print(values) 
}
            
```
```{r}
drug_lines_ac <- t(effective_in_all_doses_ac)
astrocytoma_bc[ , cell_lines[1]]

```

